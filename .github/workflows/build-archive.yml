name: Build Archive (Alternative)

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘
    inputs:
      create_release:
        description: 'Create a release'
        required: false
        default: 'false'

jobs:
  build-archive:
    name: Build Xcode Archive
    runs-on: macos-14
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'
        
    - name: Build Archive (No Code Sign)
      working-directory: Tocik/Tocik
      run: |
        set -e
        
        echo "ğŸ”¨ Building Tocik Archive..."
        
        # åˆ›å»ºæ„å»ºç›®å½•
        mkdir -p build
        
        # æ„å»º Archiveï¼ˆç¦ç”¨ä»£ç ç­¾åï¼‰
        xcodebuild archive \
          -project Tocik.xcodeproj \
          -scheme Tocik \
          -configuration Release \
          -archivePath build/Tocik.xcarchive \
          -sdk iphoneos \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          | tee build/build.log | xcpretty || true
          
        echo "âœ… Archive created successfully"
        
    - name: Package Archive
      working-directory: Tocik/Tocik
      run: |
        # å‹ç¼© Archive
        cd build
        zip -r Tocik.xcarchive.zip Tocik.xcarchive
        
        # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
        ls -lh Tocik.xcarchive.zip
        
    - name: Extract APP
      working-directory: Tocik/Tocik/build
      run: |
        # æå– .app æ–‡ä»¶
        if [ -d "Tocik.xcarchive/Products/Applications/Tocik.app" ]; then
          mkdir -p Payload
          cp -r Tocik.xcarchive/Products/Applications/Tocik.app Payload/
          
          # åˆ›å»º IPA
          zip -r Tocik-unsigned.ipa Payload
          
          echo "âœ… IPA created: Tocik-unsigned.ipa"
          ls -lh Tocik-unsigned.ipa
        else
          echo "âŒ Tocik.app not found in archive"
          find Tocik.xcarchive -name "*.app"
        fi
        
    - name: Upload Archive
      uses: actions/upload-artifact@v4
      with:
        name: Tocik-Archive
        path: |
          Tocik/Tocik/build/Tocik.xcarchive.zip
          Tocik/Tocik/build/Tocik-unsigned.ipa
        retention-days: 30
        
    - name: Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: Tocik/Tocik/build/*.log
        retention-days: 7

